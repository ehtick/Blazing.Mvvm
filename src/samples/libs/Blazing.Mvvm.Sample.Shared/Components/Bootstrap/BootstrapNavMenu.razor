@using Microsoft.AspNetCore.Components.Routing
@using Blazing.Common
@inherits ComponentControlBase
@implements IDisposable

<ul class="list-unstyled ps-0">
    <CascadingValue Value="this">
        @ChildContent
    </CascadingValue>
</ul>

@code {
    private readonly Dictionary<string, bool> _expandedGroups = new();
    private readonly List<BootstrapNavMenuGroup> _groups = new();

    [Inject]
    private NavigationManager NavigationManager { get; set; } = null!;

    protected override void OnInitialized()
    {
        base.OnInitialized();
        NavigationManager.LocationChanged += OnLocationChanged;
    }

    private async void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        // Reset all groups to collapsed on navigation
        _expandedGroups.Clear();
        
        // Reset each group's check flag so they re-check on next render
        foreach (var group in _groups)
        {
            group.ResetActiveCheck();
        }
        
        // Trigger re-render which will cause groups to check for active links
        await InvokeAsync(StateHasChanged);
    }

    internal void RegisterGroup(string groupTitle, BootstrapNavMenuGroup group)
    {
        if (!_groups.Contains(group))
        {
            _groups.Add(group);
        }
    }

    internal void ExpandGroup(string groupTitle)
    {
        // Auto-expand this group (set to true)
        _expandedGroups[groupTitle] = true;
        StateHasChanged();
    }

    internal bool IsGroupExpanded(string groupTitle)
    {
        // Check if explicitly set (either expanded or collapsed)
        return _expandedGroups.TryGetValue(groupTitle, out bool expanded) && expanded;
    }

    internal void ToggleGroup(string groupTitle)
    {
        if (_expandedGroups.ContainsKey(groupTitle))
        {
            _expandedGroups[groupTitle] = !_expandedGroups[groupTitle];
        }
        else
        {
            // First manual toggle: expand it
            _expandedGroups[groupTitle] = true;
        }
        StateHasChanged();
    }

    public new void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
        base.Dispose();
    }
}
